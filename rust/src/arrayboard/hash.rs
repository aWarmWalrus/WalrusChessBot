use crate::piece::{piece_type, PieceType};

const PIECE_SQUARE_VALUES: [u64; 736] = [
    16270727204623936583,
    6745603412284927352,
    15861665345494806169,
    715600522092062454,
    12812289005954365150,
    16593496832732116173,
    12836981245427412335,
    9595825777902696218,
    12220242405363422730,
    2019542594098568919,
    15542166490268228412,
    8068930836463918103,
    12528527368287127969,
    1094585792638704191,
    2859356709225382684,
    17336487437902105672,
    7428032345320538440,
    1321051838948102035,
    9560749711994034838,
    14834552522362065904,
    12327015042818292054,
    10046604638548483984,
    3545841455580967396,
    11055799077530652616,
    887085414710618161,
    5662706532511146233,
    6877041698017397111,
    6650425610824090227,
    13031282099702202457,
    14704796337431375437,
    7119226350327462342,
    9856448758830512418,
    2115390795144388649,
    16144519458324867579,
    17273164158131933298,
    18162281470637725124,
    11767337728326942045,
    11904023358592320932,
    16204765300436096775,
    10908847042729861210,
    2541447231523361195,
    14196753743276703875,
    869475896474554724,
    17339816625713475075,
    4057332212097386983,
    11961427396206116002,
    15733507046761258651,
    14524324720019191174,
    4815587868769433883,
    9169878599356533050,
    3195115240096036433,
    5088091466302709848,
    4945777679759883533,
    11268948677214179196,
    3923064490882861742,
    15570099022188321969,
    13761047902589401493,
    14784027065969422611,
    5544096719616173243,
    10834522641042848512,
    13104655948830178611,
    11099979347743529048,
    7094481002199073925,
    2785681534700364335,
    11667714903996889606,
    6941163749368761277,
    7052381964707266510,
    15641650357831679431,
    8177003846239544635,
    2895560494359897600,
    16787987114986917034,
    1546361458402204260,
    15259137990343973601,
    7005318959583805063,
    15375167984713109559,
    12843681526937316184,
    5646902348114975751,
    16050377266650704104,
    8340956393965411759,
    10921599029467473778,
    15712402189721662358,
    17515871013396843551,
    11087729840954865413,
    6728483242342669507,
    4664606607414015044,
    2464110678467450622,
    4911910701796855015,
    7926809191921442559,
    10667426617072197372,
    17504542615415265549,
    13701236623063091458,
    15584785327335918095,
    9089832268346258596,
    14175355820880025355,
    17466737461048824331,
    4598698642649298289,
    3822520643601699643,
    10083374637200289845,
    5180027418169179915,
    14207636246286874359,
    7010511530919241327,
    1188649776943903915,
    15783510256816899067,
    14525976814530801923,
    12365554140017808028,
    12614983712376064227,
    14447813548180310373,
    15381670210175405885,
    691169219926670404,
    4216974272667983256,
    5470064118068415634,
    10205465438579905408,
    14901682589139874065,
    9473470920795802401,
    10384687278066568707,
    17124586781296061476,
    17036910814503132469,
    15229536988510930685,
    12656691698564602628,
    8460293036965287851,
    10301266708128783518,
    297881490496262162,
    71267932554791963,
    4808995366316707042,
    8478971977789616845,
    7244403702270334023,
    1781303186775652467,
    12402238521570789070,
    17777757803885125111,
    15155493238167680662,
    10546231921800663493,
    625986424847422241,
    12668114564777166083,
    7641417631637992064,
    17289836576668615816,
    5271864943942666754,
    17723063121544910950,
    4445922132272404378,
    3377957788002378057,
    14943891149146372590,
    11479966635694061197,
    8315908678095148849,
    9275567867334701222,
    932497428727486794,
    8200601425202104754,
    9665825892172426889,
    16384169087799215774,
    16185021430065479725,
    4129593546360498802,
    8138180138035213850,
    10671174687988321307,
    14831202284387774052,
    8194202703668214022,
    4420718565920358702,
    2345889666255676209,
    4620194120423692704,
    6773882989122529036,
    10065341869974187293,
    13917753386902483886,
    14399083598116927812,
    10324789740111686887,
    2297408135415597936,
    15069968173776156541,
    4100078922480864445,
    13761640513063840787,
    6085619795768243341,
    9335219579131946644,
    17300312076440537845,
    15349410902666540315,
    756842402085518332,
    1428307005147065878,
    1002024538400705603,
    12084589489472849516,
    11593181645292736984,
    16378418624896262118,
    884160438592557182,
    1757795657905717815,
    14852231793093040090,
    2679620066867388260,
    17409302257199603643,
    6467267401153895465,
    18328815416278128227,
    14047553730243000729,
    9219530277458415729,
    14981489845838770600,
    3185224192737400167,
    13688674353005353757,
    7117013486475050645,
    16979010527725070691,
    16443939442818963851,
    9239096497167730972,
    41772725450586886,
    3938262668918312876,
    15377010648958001498,
    15289294699361978043,
    16053436108324562320,
    11982563647384371611,
    14311836211401218409,
    15777682640539536046,
    6733662654853167699,
    5884785399933964699,
    4694157544693731518,
    11324875338113528636,
    18368743112113024061,
    9786296041948658861,
    8899173745693247954,
    17253247305157552125,
    13235669842645808175,
    7669954653783559646,
    5321322154633270274,
    5794723803232427647,
    6666256992364208160,
    1892993458364414782,
    7509577846174267381,
    16697875111373196722,
    10882261883406383297,
    6771426302344238775,
    3419495217678883382,
    7029929999803355133,
    17133237344532050416,
    8180246547104584179,
    8031391869099697793,
    6268692563907461336,
    12434212288604291365,
    11129049584886139181,
    832598265122528592,
    17963297679570043992,
    12329725361650605244,
    2251737308087618407,
    10912251551786536986,
    16968746030102377163,
    4548013347983025046,
    6010296716634200698,
    4590566917353796582,
    11974564621586678296,
    15975278939813265799,
    3462667688895138274,
    8233747114561568191,
    18041419776220714288,
    11605356492414978049,
    1641823656602175398,
    3049249021851163313,
    13224090455432555151,
    4514744708652001226,
    18281714660610296932,
    10348369007138080343,
    8597969010448559818,
    15108121381615640984,
    3431194465011590641,
    15453183586521973767,
    7125272305978427476,
    6261988589562330605,
    11608602640615444422,
    3886204580230784026,
    5246711035320853709,
    3354364545022737813,
    3121330716251050368,
    8395586719389196332,
    3933364019906652525,
    13793017188040935702,
    10798518540478091136,
    618241763633244016,
    11229804035402097078,
    11560060930067845505,
    6225254851467815175,
    15703328666668509809,
    3666043000771575024,
    16253042527277312099,
    3720792060867683525,
    16997707577638762338,
    7624431036604236911,
    8408007931812942650,
    1269230877280168382,
    17590609309021666999,
    2529018945874374168,
    11118431920082859996,
    2714429786637057332,
    9739139671623445597,
    11775719904893156925,
    3989259787290342727,
    2228545101156187504,
    13789588566351623272,
    14192559665233397161,
    5701692622348133466,
    7075266670291091896,
    12618734888330282211,
    14991243815606623790,
    10523387915298246574,
    8904194436424599282,
    18103105079207911397,
    11303831328429489398,
    12956135374508528408,
    5132139686759903519,
    17804245061527590385,
    4421664148544186083,
    2862907888252494604,
    17745936657968137730,
    14773241267354986199,
    9064695799204685036,
    6089032420787496061,
    6705899591882593611,
    14947631766728577089,
    12136968986060345564,
    10895357800796819363,
    15733520870108539110,
    6909279447687793631,
    648217153015829093,
    17950227206739966833,
    4688755620593725234,
    4113884582182898952,
    61792898358639750,
    13657726795224515301,
    5396184169924840145,
    17928709716294558061,
    15895485257922838522,
    11209069851085778305,
    1442713770362830968,
    5025172835606673899,
    6818573914643877862,
    4307664689303992236,
    14046917823408321855,
    14515682428503953619,
    7644733366770046258,
    4713754859461033154,
    10904233882530250042,
    15022464872129506581,
    16696631608811003931,
    5566105156569694714,
    13145251300168489722,
    11020544188311511256,
    13152540380258828348,
    15051963974444821993,
    16957052279943558838,
    16633026048234336230,
    10331699915934971607,
    17142349210599893149,
    10116861305854373132,
    12963579651076836687,
    1598591996643084150,
    15352113950606075884,
    14894558799303447624,
    17910996104292360512,
    15640685057471650694,
    18434469481654908182,
    8323636664715527269,
    13093514481295273782,
    13339015461814568646,
    9455280345229251784,
    6847814672348415830,
    7508679405461109123,
    6644912570889059914,
    6918492047800069284,
    15751849913692044908,
    11565741314076563100,
    18107136500674998627,
    15355479895282327887,
    14279462822519800485,
    14296416612004684817,
    11732253428607384633,
    14566821348001471880,
    1483902712882178902,
    13566421465181028754,
    16613972296015256523,
    8940279743825894821,
    6436551103359329274,
    17159634608793380403,
    12128782718630109111,
    7555535960508043229,
    5404780600520212271,
    10823393002987120673,
    827667796519037270,
    11774746094086879338,
    4878488139802590383,
    17681071172338044386,
    5427051404059598292,
    11182964178169633975,
    450254465494943399,
    14659889685936248267,
    16999301626689492453,
    15904061278760495456,
    17648935282561296454,
    16856119682999369706,
    2270200437080959350,
    13060721907598793519,
    15590059563245385727,
    16673072141805557427,
    12536264452311259965,
    11036185680149867449,
    16351830605232580655,
    12835926882443666163,
    664332328597579470,
    12518410221377040111,
    3661848477345867242,
    11439839469130659879,
    14127548664401581051,
    792966780509973106,
    8815173709180869129,
    15110723565385839548,
    14958093874017705915,
    455486630360921178,
    637721307620258746,
    14784816972195156074,
    9264570847272078783,
    12456421679918383172,
    17931458114920843287,
    9830097170976941529,
    7931613678831435806,
    2174353629805802463,
    17827116468588657184,
    8391099111472798570,
    14578140185139677772,
    9167517103225905841,
    9723029360895612321,
    3017518155506041967,
    3633260269388091272,
    17083762045197052978,
    503971245903636826,
    9158086317605507299,
    8523096707326858014,
    12676528900431823614,
    4120480607248910162,
    3490298090977757799,
    11895162988897903051,
    9198124107321579390,
    5167109724122319988,
    17822642125248365751,
    13501285599910535918,
    13047373914944230876,
    9433027167320088011,
    16706281758094166311,
    1141589938525605921,
    963431789606851645,
    15917310308528623181,
    5397601981633152193,
    4439269667536149628,
    13273570918159745389,
    13103304781826019495,
    15820274832510006007,
    12451278756810493136,
    3592547959669460423,
    16100445631509525076,
    6468875731524060612,
    8661675986434436181,
    13741815998498063667,
    10592695495923605423,
    2141256453856957233,
    14569998981785731418,
    3905915444832260823,
    14026047612598544852,
    18368755825904894701,
    2968954341064086226,
    16304668286177663913,
    5886001017940328747,
    7721714060244926518,
    14321562760217149540,
    1595386624689734707,
    16088893862003697775,
    8139215022740939885,
    4447841444152439977,
    4258230230426252124,
    15210166721010962867,
    9757151303369614437,
    14046845565470053187,
    15998604459100311612,
    5651265382339407905,
    15859711041314480936,
    5458472576979937154,
    4927486338921216721,
    10446799258280518181,
    6645981603569466109,
    2454763869675060592,
    8192719191783450544,
    3403756174997752147,
    4855981269303031403,
    4260672816710792943,
    7225196557783561066,
    13748214683876371872,
    10200592718482992213,
    3473614611235676719,
    4932503122616404990,
    7285862943581642465,
    5245404734446361576,
    15071789605640867297,
    2311705434391544297,
    309914145713375950,
    17835045661224431813,
    7117471914080071332,
    12665475001546371496,
    8553335158661044212,
    15981385292664557830,
    11020184044008114452,
    11280646313115598201,
    10654435889946593690,
    14400816430318903458,
    13754899547569124013,
    5743640442881618279,
    14598521147574899601,
    5532628769035421098,
    12002401535249749783,
    15213957320626156566,
    7067620408870549239,
    17869049621239909113,
    6564107672480593648,
    2295225437917578179,
    11943731868691264904,
    13346152517084440595,
    16717388584715395677,
    12797312816527955633,
    4436314121748864423,
    4518883085180821110,
    9846273962151931636,
    2141335231889003352,
    1250049611843979827,
    1222345368006714914,
    9507701955703435550,
    4420371777738701978,
    3328309529069821802,
    4763717338295483802,
    7731647959423664131,
    6521571841932804866,
    3015936290153608061,
    8636693531345118105,
    3399361039114206373,
    13790532506103479753,
    6466275581631370196,
    3111749726441143407,
    17795708783516140567,
    16891788935792170133,
    6120579713679059343,
    17198269754257064926,
    5938540631409895633,
    15111973012566152680,
    6005789250889659571,
    13873986504825354836,
    3494181550244362958,
    13611753288876479951,
    193081129305518062,
    3987301231103182164,
    17975665814636191846,
    17586868987861071503,
    3890417421608123705,
    5692796449994345771,
    2513773473383754608,
    11507579512794737881,
    9489033281117873520,
    1308490986619805815,
    1776910540200553122,
    83709904202752206,
    5672231454386019647,
    4364388794556473394,
    1241179600492360243,
    714168411193479018,
    17901703935946908960,
    12957460257828774014,
    10029988971091645106,
    5458268630064847087,
    15627237144340385386,
    15543819631144658525,
    6821701122723530379,
    15610383426105391047,
    10778186308446059836,
    3933474303217426555,
    1755101425647888437,
    17056238458481041656,
    1153531546889461901,
    13840014243042683805,
    2584189129899780424,
    3829647331728612436,
    14147542198493552722,
    13667934472551875648,
    15545475589372186885,
    10860283960863517975,
    14798572482217703533,
    869466657808198598,
    806628463238341236,
    17996205237070343727,
    2583693614266821152,
    12846038320775071095,
    12186129982154221973,
    17423815127505443824,
    6494761678875987619,
    8349989089227239971,
    7233187007204708625,
    9472616441892604115,
    14464776983932961998,
    16816893179692569083,
    11839955270255487568,
    15916372476255573233,
    2355303535482718649,
    5568980306625369730,
    860461270663089969,
    9132274887789098611,
    3364301457913802805,
    15164899918014081916,
    1346439907914390797,
    16218233827621619407,
    6014890171177333601,
    14738285990785283074,
    7909740477800411491,
    17849180896442443718,
    9350701363640647772,
    5980833837669415623,
    6520115355194751575,
    7675786954550749320,
    2824525944287352176,
    4390194354771126390,
    17862667595284537574,
    10619571411924324965,
    399723105286052170,
    13007583180520998559,
    7971591815620529033,
    2968457001851560503,
    13243841997292679115,
    17984157037266259252,
    8525699773462280539,
    8242327452671454914,
    15767168662970413879,
    6705592925450105338,
    10608764773473473135,
    10349593310377519544,
    15978870489690304965,
    13774332605406264405,
    974981452832381043,
    18024650894527453929,
    4822566848380853210,
    4824471656597407188,
    9783444712672104769,
    11339276402949826443,
    4864580287880585070,
    9879984364374485521,
    13432247280112614937,
    4600325535000592789,
    14577752438989157122,
    11307307305651145742,
    7125510760611295556,
    10676109231425186917,
    14502365372446140261,
    10005447300614908511,
    9004850028751339259,
    8794304133150998595,
    18215433891114488020,
    16843422751099372567,
    6305480825504695899,
    4088201497616866399,
    13025529312654325470,
    4979903552250947740,
    7925076324381259611,
    3526636526782487668,
    3868792236413023825,
    14776724762290921262,
    8092093065426576083,
    7803963647911911826,
    4679119238800432808,
    12863937492161099253,
    14732985749660253412,
    6462071020795264522,
    10779082562595527104,
    1095012478269460090,
    2697080803362870072,
    3971667935490227466,
    952872633641322479,
    7041934018399807073,
    233333930431414312,
    18210964059886424732,
    9476107475243314363,
    12345932089322263784,
    17376429940578947001,
    17473826320210724121,
    16599238164401213606,
    988687126902661686,
    1985270984615104813,
    6737221095098916441,
    5082862731132480190,
    18378250801818297158,
    15100111383348588445,
    4527224169964338910,
    13116771254161749951,
    9368239013437214180,
    1548064812769672863,
    13295424112996146481,
    13673761902361864838,
    12172970967149730578,
    9355995571784537984,
    5342756056804221554,
    7249981059382378606,
    11625225473838188091,
    10642235224701841954,
    2482286477934704036,
    1021753522809932157,
    1097123416410968661,
    951855205023133346,
    17420478482297323387,
    13782612906492636695,
    9245397119605117745,
    5737772486249013693,
    16517650529776839303,
    6142860027013828180,
    4263420149087207003,
    7983007935730342827,
    9240944678007166724,
    6301632782286379386,
    17877717471740698899,
    5971983724526506570,
    6870191681730173959,
    15087782689652644469,
    9880230584813877314,
    9717643176091989389,
    5192554638390426459,
    9979085505253193656,
    18133545575552357135,
    17287351623542955142,
    10783008921258200782,
    6302348552370593744,
    4377854462504607159,
    2205735802540813847,
    7061046042542178779,
    6000294344929134657,
    15050049294939686000,
    4360290183723982209,
    17524528109975239930,
    440814809934466838,
    2600365054311080836,
    11384949338077590386,
    4610784329767877298,
    3023434183316157713,
    6694450276732501921,
    8581495607033265212,
    16308931396278796603,
    5665814365887629542,
    7806544779334620514,
    8242188332089117944,
    9676754778500222718,
    7286132442517394627,
    9731944902900790097,
    11560902892353565768,
    3206640100493458191,
];

const SEED: u64 = 4358979348738523823;
const SIDE_TO_MOVE: u64 = 6012934856394834233;
const CASTLE_RIGHTS: [u64; 16] = [
    7396512047044821290,
    3856622725498071919,
    8824779268271327806,
    17815081531308031988,
    147384730100802552,
    1510629138993448394,
    4328122763908840357,
    4829324335028393182,
    18038770440826348028,
    6135715231044771689,
    8774942558521314889,
    15884884693947703056,
    11346812261607259108,
    11242360099382390371,
    1248872444874553170,
    15266933966999412345,
];
const ENPASSANT: [u64; 8] = [
    4345509870086807849,
    8107547990543365062,
    2691086430151438761,
    1916239738072280582,
    13958099368800330946,
    77535870290397597,
    9203140695867980400,
    17305182826536410005,
];

pub fn initial_hash() -> u64 {
    SEED
}

// Piece side is at 0 bit, and empty piece type is equal to 0. Thus here are the piece bit values:
//  0, 1: empty      0000,  0001
//  2: black pawn    0010
//  3: white pawn    0011
//  4: black knight  0100
//  5: white knight  0101
//  6: black bishop
//  7: white bishop
//  8: black rook
//  9: white rook
// 10: black queen
// 11: white queen
// 12: black king
// 13: white king
// And each piece gets 64 hashes, one for each square it can possibly occupy. The exceptions are
// pawns--since they can't occupy 1st and 8th rank, they only have 48 hashes. Thus the addresses
// are as follows:
//   0..47:  black pawn hashes
//  48..95:  white pawn hashes
//  96..159: black knight hashes
// 160..223: white knight hashes
// 224..287: black bishop hashes
// 288..351: white bishop hashes
// and so forth.
pub fn hash_piece(hash: u64, piece_bits: u8, index: usize) -> u64 {
    let i = match piece_type(piece_bits as u32) {
        PieceType::Pawn => (piece_bits - 2) * 48 + (index as u8 - 8),
        _ => 96 + (piece_bits - 4) * 64 + (index as u8),
    } as usize;
    hash ^ PIECE_SQUARE_VALUES[i]
}

pub fn hash_side_to_move(hash: u64) -> u64 {
    hash ^ SIDE_TO_MOVE
}

pub fn hash_castle_rights(hash: u64, old: u8, new: u8) -> u64 {
    // Even though xor is its own inverse, save 2 memory lookups maybe by avoiding the hashing?
    if old == new {
        hash
    } else {
        hash ^ CASTLE_RIGHTS[old as usize] ^ CASTLE_RIGHTS[new as usize]
    }
}

pub fn hash_enpassant(mut hash: u64, old: u8, new: u8) -> u64 {
    let old_col = 0b111 & old as usize;
    let new_col = 0b111 & new as usize;
    if old_col == new_col {
        return hash;
    }
    if old != 0 {
        hash = hash ^ ENPASSANT[old_col];
    }
    if new != 0 {
        hash = hash ^ ENPASSANT[new_col];
    }
    hash
}
